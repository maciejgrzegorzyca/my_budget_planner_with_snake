{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block content %}
    <div class="container form-container mt-5">
        <div class="p-3 bg-white border border-light rounded shadow">
            <div class="row px-2">
                <span class="mb-2 border-bottom border-2">
                    <h1 class="fs-3">Your transaction categories</h1>
                </span>
                
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div id="toolbar">
                        <a href="{% url 'planner:new_category' %}?back_url={{ request.path }}"
                            class="btn btn-outline-success">New category
                        </a>
                        <button type="button" class="btn btn-outline-danger" onclick="deleteRows()">Delete selected</button>
                    </div>
                    <table id="table" 
                        data-select-item-name="selected"
                        data-toggle="table" 
                        data-search="true" 
                        data-show-export="true"
                        data-toolbar="#toolbar" 
                        data-show-toggle="true" 
                        data-toolbar-align="left"
                        data-show-fullscreen="true" 
                        data-pagination="true" 
                        data-classes="
                            table 
                            table-responsive
                            table-hover
                            align-middle">
                        <thead>
                            <tr>
                                <th data-field="state" data-checkbox="true"></th>
                                <th data-field="id" data-visible="false">id</th>
                                <th data-field="category_name">Category name</th>
                                <th data-field="type">Type</th>
                                <th data-field="is_default">Is default?</th>
                                <th data-field="user">User</th>
                                <th data-field="action" data-formatter="actionFormatter" data-events="actionEvents"
                                    ata-footer-formatter="footerFormatter">Edit</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for obj in categories %}
                            <tr>
                                <td></td>
                                <td>{{ obj.id }}</td>
                                <td>{{ obj.category_name }}</td>
                                <td>{{ obj.type }}</td>
                                <td>{{ obj.default }}</td>
                                <td>{{ obj.users }}</td>
                                <td></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        </div>
        

    <script>
        function actionFormatter() {
            return '<button class="btn btn-outline-secondary btn-sm">Click</>'
        }
    </script>
    <script>
        // Define the deleteRows function
        function deleteRows() {
            // Get the selected rows
            var selectedRows = $('#table').bootstrapTable('getSelections');
            var csrf_token = '{{ csrf_token }}';
            // Check if any rows are selected
            if (selectedRows.length > 0) {
                // Check if any selected rows are default
                var defaultRows = $.grep(selectedRows, function (row) {
                    return row.is_default === "True";
                });
                if (defaultRows.length > 0) {
                    // Show an error message if default rows are selected
                    alert('Default categories cannot be deleted.');
                } else {
                    // Ask the user to confirm the deletion
                    if (confirm('Are you sure you want to delete the selected rows?')) {
                        // Get the IDs of the selected rows
                        var ids = $.map(selectedRows, function (row) {
                            return row.id;
                        });
                        // Send the AJAX request to delete the rows
                        $.ajax({
                            url: 'delete_categories/',
                            type: 'POST',
                            data: {'ids': ids, csrfmiddlewaretoken: csrf_token},
                            dataType: 'json',
                            success: function (data) {
                                if (data.success) {
                                    // Remove the selected rows from the table
                                    $('#table').bootstrapTable('remove', {
                                        field: 'id',
                                        values: ids
                                    });
                                    // Show a success message
                                    alert('Selected rows have been deleted.');
                                } else {
                                    // Show an error message
                                    alert('Failed to delete selected rows.');
                                }
                            },
                            error: function () {
                                // Show an error message
                                alert('Failed to delete selected rows.');
                            }
                        });
                    }
                }
            } else {
                // Show a warning message if no rows are selected
                alert('Please select one or more rows to delete.');
            }
        }

    </script>
{% endblock content %}